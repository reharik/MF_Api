"use strict";

module.exports = function(rsRepository,
                          notificationListener,
                          notificationParser,
                          eventstore,
                          uuid,
                          logger,
                          authentication) {

  var hireTrainer = async function (ctx) {
    logger.debug("arrived at trainer.hireTrainer");
    const payload = ctx.request.body;
<<<<<<< HEAD
    payload.password = authentication.createPassword(payload.password);
    const notification = await processMessage(payload, 'hireTrainer');
    ctx.body = {success: notification.result != 'Failure', result: notification.handlerResult};
    ctx.status = notification.result === 'Success' ? 200 : 500;
=======
    payload.credentials.password = authentication.createPassword(payload.credentials.password);
    const result = await processMessage(payload, 'hireTrainer');

    ctx.body = result.body;
    ctx.status = result.status;
>>>>>>> 6161e7896d00eaf0ac40bb266c43e620f86b08d1
  };

  var updateTrainerInfo = async function (ctx) {
    logger.debug("arrived at trainer.updateTrainerInfo");
<<<<<<< HEAD
    const notification = await processMessage(ctx.request.body, 'updateTrainerInfo');
    ctx.body = {success: notification.result != 'Failure', result: notification.handlerResult};
    ctx.status = notification.result === 'Success' ? 200 : 500;
=======
    const result = await processMessage(ctx.request.body, 'updateTrainerInfo');

    ctx.body = result.body;
    ctx.status = result.status;
>>>>>>> 6161e7896d00eaf0ac40bb266c43e620f86b08d1
  };

  var updateTrainerContact = async function (ctx) {
    logger.debug("arrived at trainer.updateTrainerContact");
<<<<<<< HEAD
    const notification = await processMessage(ctx.request.body, 'updateTrainerContact');
    ctx.body = {success: notification.result != 'Failure', result: notification.handlerResult};
    ctx.status = notification.result === 'Success' ? 200 : 500;
=======
    const result = await processMessage(ctx.request.body, 'updateTrainerContact');

    ctx.body = result.body;
    ctx.status = result.status;
>>>>>>> 6161e7896d00eaf0ac40bb266c43e620f86b08d1
  };

  var updateTrainerAddress = async function (ctx) {
    logger.debug("arrived at trainer.updateTrainerAddress");

<<<<<<< HEAD
    const notification = await processMessage(ctx.request.body, 'updateTrainerAddress');
    ctx.body = {success: notification.result != 'Failure', result: notification.handlerResult};
    ctx.status = notification.result === 'Success' ? 200 : 500;
=======
    const result = await processMessage(ctx.request.body, 'updateTrainerAddress');
    
    ctx.body = result.body;
    ctx.status = result.status;
>>>>>>> 6161e7896d00eaf0ac40bb266c43e620f86b08d1
  };

  var updateTrainerPassword = async function (ctx) {
    logger.debug("arrived at trainer.updateTrainerPassword");
    const payload = ctx.request.body;
    payload.password = authentication.createPassword(payload.password);
<<<<<<< HEAD
    const notification = await processMessage(payload, 'updateTrainerPassword');
    ctx.body = {success: notification.result != 'Failure', result: notification.handlerResult};
    ctx.status = notification.result === 'Success' ? 200 : 500;
=======
    const result = await processMessage(payload, 'updateTrainerPassword');
    
    ctx.body = result.body;
    ctx.status = result.status;
>>>>>>> 6161e7896d00eaf0ac40bb266c43e620f86b08d1
  };

  var updateTrainersClients = async function (ctx) {
    logger.debug("arrived at trainer.updateTrainersClients");

<<<<<<< HEAD
    const notification = await processMessage(ctx.request.body, 'updateTrainersClients');
    ctx.body = {success: notification.result != 'Failure', result: notification.handlerResult};
    ctx.status = notification.result === 'Success' ? 200 : 500;
=======
    const result = await processMessage(ctx.request.body, 'updateTrainersClients');
    
    ctx.body = result.body;
    ctx.status = result.status;
  };

  var archiveTrainer = async function (ctx) {
    logger.debug("arrived at trainer.archiveTrainer");

    const result = await processMessage(ctx.request.body, ctx.request.body.archived ? 'unArchiveTrainer' : 'archiveTrainer');

    ctx.body = result.body;
    ctx.status = result.status;
>>>>>>> 6161e7896d00eaf0ac40bb266c43e620f86b08d1
  };

  var processMessage = async function(payload, commandName) {
    const continuationId = uuid.v4();
    let notificationPromise = notificationListener(continuationId, commandName);

    const command = messageBinders.commands[commandName + 'Command'](payload);

    await eventstore.commandPoster(
      command,
      commandName,
      continuationId);

    const notification = await notificationPromise;
    return notificationParser(notification);
  };

  var getTrainer = async function (ctx) {
    const trainer = await rsRepository.getById(ctx.params.id, 'trainer');
    ctx.status = 200;
    ctx.body = trainer;
  };

  return {
    hireTrainer,
    updateTrainerInfo,
    updateTrainerContact,
    updateTrainerAddress,
    updateTrainerPassword,
    updateTrainersClients,
    archiveTrainer,
    getTrainer
  };
};

